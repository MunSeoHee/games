name: Deploy to Server

on:
  workflow_dispatch:  # 수동 실행만 가능

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          # cache는 package-lock.json이 있을 때만 작동하므로 선택적으로 설정
          cache: 'npm'
          cache-dependency-path: |
            backend/package-lock.json
            frontend/package-lock.json
        continue-on-error: true  # 캐시 실패해도 계속 진행

      # 백엔드 빌드
      - name: Install backend dependencies
        run: |
          cd backend
          npm install

      - name: Build backend
        run: |
          cd backend
          npm run build

      # 프론트엔드 빌드
      - name: Install frontend dependencies
        run: |
          cd frontend
          npm install

      - name: Build frontend
        env:
          VITE_API_URL: ${{ secrets.VITE_API_URL }}
          VITE_SOCKET_URL: ${{ secrets.VITE_SOCKET_URL }}
        run: |
          cd frontend
          npm run build

      # 서버에 배포
      - name: Deploy backend files
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.DEPLOY_HOST }}
          username: ${{ secrets.DEPLOY_USER }}
          key: ${{ secrets.DEPLOY_SSH_KEY }}
          port: ${{ secrets.DEPLOY_PORT || 22 }}
          source: "backend/dist,backend/package.json,backend/package-lock.json,backend/copy-shared.js"
          target: ${{ secrets.DEPLOY_PATH || '/var/www/game-platform' }}/backend
          strip_components: 1

      - name: Deploy frontend files
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.DEPLOY_HOST }}
          username: ${{ secrets.DEPLOY_USER }}
          key: ${{ secrets.DEPLOY_SSH_KEY }}
          port: ${{ secrets.DEPLOY_PORT || 22 }}
          source: "frontend/dist"
          target: ${{ secrets.DEPLOY_PATH || '/var/www/game-platform' }}/frontend
          strip_components: 1

      - name: Deploy shared folder
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.DEPLOY_HOST }}
          username: ${{ secrets.DEPLOY_USER }}
          key: ${{ secrets.DEPLOY_SSH_KEY }}
          port: ${{ secrets.DEPLOY_PORT || 22 }}
          source: "shared"
          target: ${{ secrets.DEPLOY_PATH || '/var/www/game-platform' }}
          strip_components: 0

      - name: Run deployment script on server
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.DEPLOY_HOST }}
          username: ${{ secrets.DEPLOY_USER }}
          key: ${{ secrets.DEPLOY_SSH_KEY }}
          port: ${{ secrets.DEPLOY_PORT || 22 }}
          script: |
            # PATH 설정 (nvm 사용 시)
            export NVM_DIR="$HOME/.nvm"
            [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"
            [ -s "/usr/local/nvm/nvm.sh" ] && \. "/usr/local/nvm/nvm.sh"
            
            # nvm으로 설치된 Node.js 경로 추가
            if [ -d "$HOME/.nvm/versions/node" ]; then
              NODE_VERSION=$(ls -t "$HOME/.nvm/versions/node" | head -1)
              export PATH="$PATH:$HOME/.nvm/versions/node/$NODE_VERSION/bin"
            fi
            
            # Node.js 경로 확인 및 PATH 추가
            if command -v node >/dev/null 2>&1; then
              echo "✓ Node.js found: $(which node) ($(node --version))"
            elif [ -f "/usr/bin/node" ]; then
              export PATH="/usr/bin:$PATH"
              echo "✓ Node.js found: /usr/bin/node"
            elif [ -f "/usr/local/bin/node" ]; then
              export PATH="/usr/local/bin:$PATH"
              echo "✓ Node.js found: /usr/local/bin/node"
            else
              echo "⚠ Node.js not found. Please install Node.js first."
              exit 1
            fi
            
            # npm 경로 확인
            if ! command -v npm >/dev/null 2>&1; then
              echo "⚠ npm not found. Checking common locations..."
              if [ -f "/usr/bin/npm" ]; then
                export PATH="/usr/bin:$PATH"
              elif [ -f "/usr/local/bin/npm" ]; then
                export PATH="/usr/local/bin:$PATH"
              else
                echo "⚠ npm not found. Please install npm first."
                exit 1
              fi
            fi
            
            # PM2 경로 확인
            if command -v pm2 >/dev/null 2>&1; then
              echo "✓ PM2 found: $(which pm2)"
            else
              echo "⚠ pm2 not found. Checking common locations..."
              # nvm으로 설치된 PM2 경로 확인
              if [ -d "$HOME/.nvm/versions/node" ]; then
                NODE_VERSION=$(ls -t "$HOME/.nvm/versions/node" | head -1)
                PM2_PATH="$HOME/.nvm/versions/node/$NODE_VERSION/lib/node_modules/pm2/bin/pm2"
                if [ -f "$PM2_PATH" ]; then
                  export PATH="$PATH:$HOME/.nvm/versions/node/$NODE_VERSION/bin"
                  echo "✓ PM2 found: $PM2_PATH"
                fi
              fi
              
              if ! command -v pm2 >/dev/null 2>&1; then
                if [ -f "/usr/bin/pm2" ]; then
                  export PATH="/usr/bin:$PATH"
                elif [ -f "/usr/local/bin/pm2" ]; then
                  export PATH="/usr/local/bin:$PATH"
                elif [ -f "$HOME/.npm-global/bin/pm2" ]; then
                  export PATH="$HOME/.npm-global/bin:$PATH"
                else
                  echo "⚠ pm2 not found. Installing pm2 globally..."
                  npm install -g pm2 || echo "⚠ Failed to install pm2"
                fi
              fi
            fi
            
            DEPLOY_PATH="${{ secrets.DEPLOY_PATH || '/var/www/game-platform' }}"
            cd $DEPLOY_PATH/backend
            
            # shared 폴더를 백엔드에 복사
            node copy-shared.js || true
            
            # .env 파일 생성 (GitHub Secrets에서 환경 변수 사용)
            cat > .env << EOF
            PORT=${{ secrets.PORT || '3002' }}
            NODE_ENV=production
            MONGODB_URI=${{ secrets.MONGODB_URI }}
            JWT_SECRET=${{ secrets.JWT_SECRET }}
            FRONTEND_URL=${{ secrets.FRONTEND_URL || '' }}
            EOF
            
            # 백엔드 의존성 설치 (production만)
            npm install --only=production || npm install --production
            
            # PM2로 백엔드 재시작
            pm2 restart game-backend || pm2 start dist/index.js --name "game-backend" --env production
            pm2 save
            
            # 프론트엔드 배포 확인 및 권한 설정
            echo "=== 프론트엔드 배포 확인 ==="
            cd $DEPLOY_PATH/frontend
            if [ -d "." ]; then
              echo "✓ 프론트엔드 디렉토리 확인됨"
              ls -la
              echo "프론트엔드 파일 목록:"
              find . -type f -name "*.html" -o -name "*.js" -o -name "*.css" | head -10 || true
              # 파일 권한 설정 (Nginx가 읽을 수 있도록)
              sudo chown -R www-data:www-data . || sudo chown -R nginx:nginx . || true
              sudo chmod -R 755 . || true
            else
              echo "⚠ 프론트엔드 디렉토리가 없습니다: $DEPLOY_PATH/frontend"
            fi
            
            # Nginx 설정 확인
            echo "=== Nginx 설정 확인 ==="
            sudo nginx -t || echo "⚠ Nginx 설정 테스트 실패"
            
            # Nginx 캐시 클리어
            echo "=== Nginx 캐시 클리어 ==="
            sudo rm -rf /var/cache/nginx/* || true
            
            # Nginx 재시작
            echo "=== Nginx 재시작 ==="
            sudo systemctl reload nginx || sudo service nginx reload || sudo systemctl restart nginx || sudo service nginx restart || true
            
            echo "=== 배포 완료 ==="
            echo "프론트엔드 경로: $DEPLOY_PATH/frontend"
            echo "백엔드 경로: $DEPLOY_PATH/backend"
