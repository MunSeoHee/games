name: Deploy to Server

on:
  workflow_dispatch:  # 수동 실행만 가능

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          # cache는 package-lock.json이 있을 때만 작동하므로 선택적으로 설정
          cache: 'npm'
          cache-dependency-path: |
            backend/package-lock.json
            frontend/package-lock.json
        continue-on-error: true  # 캐시 실패해도 계속 진행

      # 백엔드 빌드
      - name: Install backend dependencies
        run: |
          cd backend
          npm ci

      - name: Build backend
        run: |
          cd backend
          npm run build

      # 프론트엔드 빌드
      - name: Install frontend dependencies
        run: |
          cd frontend
          npm ci

      - name: Build frontend
        env:
          VITE_API_URL: ${{ secrets.VITE_API_URL }}
          VITE_SOCKET_URL: ${{ secrets.VITE_SOCKET_URL }}
        run: |
          cd frontend
          npm run build

      # 서버에 배포
      - name: Deploy backend files
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.DEPLOY_HOST }}
          username: ${{ secrets.DEPLOY_USER }}
          key: ${{ secrets.DEPLOY_SSH_KEY }}
          port: ${{ secrets.DEPLOY_PORT || 22 }}
          source: "backend/dist,backend/package.json,backend/package-lock.json,backend/copy-shared.js"
          target: ${{ secrets.DEPLOY_PATH || '/var/www/game-platform' }}/backend
          strip_components: 1

      - name: Deploy frontend files
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.DEPLOY_HOST }}
          username: ${{ secrets.DEPLOY_USER }}
          key: ${{ secrets.DEPLOY_SSH_KEY }}
          port: ${{ secrets.DEPLOY_PORT || 22 }}
          source: "frontend/dist"
          target: ${{ secrets.DEPLOY_PATH || '/var/www/game-platform' }}/frontend
          strip_components: 1

      - name: Deploy shared folder
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.DEPLOY_HOST }}
          username: ${{ secrets.DEPLOY_USER }}
          key: ${{ secrets.DEPLOY_SSH_KEY }}
          port: ${{ secrets.DEPLOY_PORT || 22 }}
          source: "shared"
          target: ${{ secrets.DEPLOY_PATH || '/var/www/game-platform' }}
          strip_components: 0

      - name: Run deployment script on server
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.DEPLOY_HOST }}
          username: ${{ secrets.DEPLOY_USER }}
          key: ${{ secrets.DEPLOY_SSH_KEY }}
          port: ${{ secrets.DEPLOY_PORT || 22 }}
          script: |
            DEPLOY_PATH="${{ secrets.DEPLOY_PATH || '/var/www/game-platform' }}"
            cd $DEPLOY_PATH/backend
            
            # shared 폴더를 백엔드에 복사
            node copy-shared.js || true
            
            # .env 파일 생성 (GitHub Secrets에서 환경 변수 사용)
            cat > .env << EOF
            PORT=${{ secrets.PORT || '3002' }}
            NODE_ENV=production
            MONGODB_URI=${{ secrets.MONGODB_URI }}
            JWT_SECRET=${{ secrets.JWT_SECRET }}
            FRONTEND_URL=${{ secrets.FRONTEND_URL || '' }}
            EOF
            
            # 백엔드 의존성 설치 (production만)
            npm ci --only=production
            
            # PM2로 백엔드 재시작
            pm2 restart game-backend || pm2 start dist/index.js --name "game-backend" --env production
            pm2 save
            
            # Nginx 재시작
            sudo systemctl reload nginx || sudo service nginx reload || true
