name: Deploy to Server

on:
  workflow_dispatch:  # 수동 실행만 가능

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          # cache는 package-lock.json이 있을 때만 작동하므로 선택적으로 설정
          cache: 'npm'
          cache-dependency-path: |
            backend/package-lock.json
            frontend/package-lock.json
        continue-on-error: true  # 캐시 실패해도 계속 진행

      # 백엔드 빌드
      - name: Install backend dependencies
        run: |
          cd backend
          npm install

      - name: Build backend
        run: |
          cd backend
          npm run build

      # 프론트엔드 빌드
      - name: Install frontend dependencies
        run: |
          cd frontend
          npm install

      - name: Build frontend
        env:
          VITE_API_URL: ${{ secrets.VITE_API_URL }}
          VITE_SOCKET_URL: ${{ secrets.VITE_SOCKET_URL }}
        run: |
          cd frontend
          npm run build

      # 서버에 배포
      - name: Deploy backend files
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.DEPLOY_HOST }}
          username: ${{ secrets.DEPLOY_USER }}
          key: ${{ secrets.DEPLOY_SSH_KEY }}
          port: ${{ secrets.DEPLOY_PORT || 22 }}
          source: "backend/dist,backend/package.json,backend/package-lock.json,backend/copy-shared.js"
          target: ${{ secrets.DEPLOY_PATH || '/var/www/game-platform' }}/backend
          strip_components: 1

      - name: Clean old frontend files on server
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.DEPLOY_HOST }}
          username: ${{ secrets.DEPLOY_USER }}
          key: ${{ secrets.DEPLOY_SSH_KEY }}
          port: ${{ secrets.DEPLOY_PORT || 22 }}
          script: |
            DEPLOY_PATH="${{ secrets.DEPLOY_PATH || '/var/www/game-platform' }}"
            FRONTEND_PATH="$DEPLOY_PATH/frontend"
            CURRENT_USER=$(whoami)
            
            echo "=== 기존 프론트엔드 디렉토리 완전 삭제 ==="
            echo "경로: $FRONTEND_PATH"
            echo "현재 사용자: $CURRENT_USER"
            
            # 디렉토리가 있으면 완전히 삭제
            if [ -d "$FRONTEND_PATH" ]; then
              echo "기존 디렉토리 발견, 삭제 중..."
              echo "삭제 전 파일 개수:"
              find "$FRONTEND_PATH" -type f | wc -l || echo "0"
              
              # 권한 문제로 삭제가 안 될 수 있으므로 여러 방법 시도
              sudo chown -R "$CURRENT_USER:$CURRENT_USER" "$FRONTEND_PATH" 2>/dev/null || true
              sudo chmod -R 777 "$FRONTEND_PATH" 2>/dev/null || true
              
              # 완전 삭제
              sudo rm -rf "$FRONTEND_PATH" || rm -rf "$FRONTEND_PATH" || true
              
              # 삭제 확인
              if [ -d "$FRONTEND_PATH" ]; then
                echo "⚠ 경고: 디렉토리가 완전히 삭제되지 않았습니다. 강제 삭제 시도..."
                sudo rm -rf "$FRONTEND_PATH"/* 2>/dev/null || true
                sudo rmdir "$FRONTEND_PATH" 2>/dev/null || true
              fi
              
              echo "✓ 기존 디렉토리 삭제 완료"
            else
              echo "기존 디렉토리가 없습니다 (정상)"
            fi
            
            # 디렉토리 재생성 및 권한 설정
            echo "=== 프론트엔드 디렉토리 생성 ==="
            sudo mkdir -p "$FRONTEND_PATH" || mkdir -p "$FRONTEND_PATH" || true
            
            # 현재 사용자에게 소유권 부여 (scp-action이 파일을 쓸 수 있도록)
            echo "=== 디렉토리 권한 설정 ==="
            sudo chown -R "$CURRENT_USER:$CURRENT_USER" "$FRONTEND_PATH" 2>/dev/null || \
            sudo chown -R "$CURRENT_USER" "$FRONTEND_PATH" 2>/dev/null || true
            
            # 쓰기 권한 부여
            sudo chmod -R 775 "$FRONTEND_PATH" 2>/dev/null || \
            chmod -R 775 "$FRONTEND_PATH" 2>/dev/null || \
            sudo chmod -R 755 "$FRONTEND_PATH" 2>/dev/null || \
            chmod -R 755 "$FRONTEND_PATH" 2>/dev/null || true
            
            echo "=== 권한 설정 완료 ==="
            ls -ld "$FRONTEND_PATH" || true
            echo "디렉토리 내용 (비어있어야 함):"
            ls -la "$FRONTEND_PATH" || true
            echo "파일 개수:"
            find "$FRONTEND_PATH" -type f 2>/dev/null | wc -l || echo "0"

      - name: Deploy frontend files
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.DEPLOY_HOST }}
          username: ${{ secrets.DEPLOY_USER }}
          key: ${{ secrets.DEPLOY_SSH_KEY }}
          port: ${{ secrets.DEPLOY_PORT || 22 }}
          source: "frontend/dist"
          target: ${{ secrets.DEPLOY_PATH || '/var/www/game-platform' }}/frontend
          strip_components: 1
          overwrite: true
          rm: false

      - name: Deploy shared folder
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.DEPLOY_HOST }}
          username: ${{ secrets.DEPLOY_USER }}
          key: ${{ secrets.DEPLOY_SSH_KEY }}
          port: ${{ secrets.DEPLOY_PORT || 22 }}
          source: "shared"
          target: ${{ secrets.DEPLOY_PATH || '/var/www/game-platform' }}
          strip_components: 0

      - name: Run deployment script on server
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.DEPLOY_HOST }}
          username: ${{ secrets.DEPLOY_USER }}
          key: ${{ secrets.DEPLOY_SSH_KEY }}
          port: ${{ secrets.DEPLOY_PORT || 22 }}
          script: |
            # PATH 설정 (nvm 사용 시)
            export NVM_DIR="$HOME/.nvm"
            [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"
            [ -s "/usr/local/nvm/nvm.sh" ] && \. "/usr/local/nvm/nvm.sh"
            
            # nvm으로 설치된 Node.js 경로 추가
            if [ -d "$HOME/.nvm/versions/node" ]; then
              NODE_VERSION=$(ls -t "$HOME/.nvm/versions/node" | head -1)
              export PATH="$PATH:$HOME/.nvm/versions/node/$NODE_VERSION/bin"
            fi
            
            # Node.js 경로 확인 및 PATH 추가
            if command -v node >/dev/null 2>&1; then
              echo "✓ Node.js found: $(which node) ($(node --version))"
            elif [ -f "/usr/bin/node" ]; then
              export PATH="/usr/bin:$PATH"
              echo "✓ Node.js found: /usr/bin/node"
            elif [ -f "/usr/local/bin/node" ]; then
              export PATH="/usr/local/bin:$PATH"
              echo "✓ Node.js found: /usr/local/bin/node"
            else
              echo "⚠ Node.js not found. Please install Node.js first."
              exit 1
            fi
            
            # npm 경로 확인
            if ! command -v npm >/dev/null 2>&1; then
              echo "⚠ npm not found. Checking common locations..."
              if [ -f "/usr/bin/npm" ]; then
                export PATH="/usr/bin:$PATH"
              elif [ -f "/usr/local/bin/npm" ]; then
                export PATH="/usr/local/bin:$PATH"
              else
                echo "⚠ npm not found. Please install npm first."
                exit 1
              fi
            fi
            
            # PM2 경로 확인
            if command -v pm2 >/dev/null 2>&1; then
              echo "✓ PM2 found: $(which pm2)"
            else
              echo "⚠ pm2 not found. Checking common locations..."
              # nvm으로 설치된 PM2 경로 확인
              if [ -d "$HOME/.nvm/versions/node" ]; then
                NODE_VERSION=$(ls -t "$HOME/.nvm/versions/node" | head -1)
                PM2_PATH="$HOME/.nvm/versions/node/$NODE_VERSION/lib/node_modules/pm2/bin/pm2"
                if [ -f "$PM2_PATH" ]; then
                  export PATH="$PATH:$HOME/.nvm/versions/node/$NODE_VERSION/bin"
                  echo "✓ PM2 found: $PM2_PATH"
                fi
              fi
              
              if ! command -v pm2 >/dev/null 2>&1; then
                if [ -f "/usr/bin/pm2" ]; then
                  export PATH="/usr/bin:$PATH"
                elif [ -f "/usr/local/bin/pm2" ]; then
                  export PATH="/usr/local/bin:$PATH"
                elif [ -f "$HOME/.npm-global/bin/pm2" ]; then
                  export PATH="$HOME/.npm-global/bin:$PATH"
                else
                  echo "⚠ pm2 not found. Installing pm2 globally..."
                  npm install -g pm2 || echo "⚠ Failed to install pm2"
                fi
              fi
            fi
            
            DEPLOY_PATH="${{ secrets.DEPLOY_PATH || '/var/www/game-platform' }}"
            cd $DEPLOY_PATH/backend
            
            # shared 폴더를 백엔드에 복사
            node copy-shared.js || true
            
            # .env 파일 생성 (GitHub Secrets에서 환경 변수 사용)
            cat > .env << EOF
            PORT=${{ secrets.PORT || '3002' }}
            NODE_ENV=production
            MONGODB_URI=${{ secrets.MONGODB_URI }}
            JWT_SECRET=${{ secrets.JWT_SECRET }}
            FRONTEND_URL=${{ secrets.FRONTEND_URL || '' }}
            EOF
            
            # 백엔드 의존성 설치 (production만)
            npm install --only=production || npm install --production
            
            # PM2로 백엔드 재시작
            pm2 restart game-backend || pm2 start dist/index.js --name "game-backend" --env production
            pm2 save
            
            # 프론트엔드 배포 확인 및 권한 설정
            echo "=== 프론트엔드 배포 확인 ==="
            FRONTEND_PATH="$DEPLOY_PATH/frontend"
            
            # 기존 프론트엔드 디렉토리 확인
            if [ -d "$FRONTEND_PATH" ]; then
              echo "기존 프론트엔드 디렉토리 발견, 내용 확인:"
              ls -la "$FRONTEND_PATH" || true
              echo "기존 파일 개수:"
              find "$FRONTEND_PATH" -type f | wc -l || echo "0"
            fi
            
            # 새로 배포된 파일 확인
            if [ -d "$FRONTEND_PATH" ]; then
              echo "✓ 프론트엔드 디렉토리 확인됨: $FRONTEND_PATH"
              cd "$FRONTEND_PATH"
              echo "현재 디렉토리: $(pwd)"
              echo "파일 목록:"
              ls -la || true
              echo "HTML 파일:"
              find . -maxdepth 2 -type f -name "*.html" || true
              echo "JS 파일 (처음 5개):"
              find . -type f -name "*.js" | head -5 || true
              echo "CSS 파일 (처음 5개):"
              find . -type f -name "*.css" | head -5 || true
              
              # 파일 권한 설정 (Nginx가 읽을 수 있도록)
              echo "파일 권한 설정 중..."
              sudo chown -R www-data:www-data "$FRONTEND_PATH" 2>/dev/null || \
              sudo chown -R nginx:nginx "$FRONTEND_PATH" 2>/dev/null || \
              sudo chown -R $USER:$USER "$FRONTEND_PATH" 2>/dev/null || true
              sudo chmod -R 755 "$FRONTEND_PATH" || sudo chmod -R 644 "$FRONTEND_PATH"/* || true
              
              echo "권한 설정 후:"
              ls -la "$FRONTEND_PATH" | head -10 || true
            else
              echo "⚠ 프론트엔드 디렉토리가 없습니다: $FRONTEND_PATH"
              echo "배포 경로 확인:"
              ls -la "$DEPLOY_PATH" || true
            fi
            
            # Nginx 설정 확인 및 업데이트
            echo "=== Nginx 설정 확인 및 업데이트 ==="
            NGINX_CONFIG="/etc/nginx/sites-available/default"
            NGINX_ENABLED="/etc/nginx/sites-enabled/default"
            FRONTEND_PATH="$DEPLOY_PATH/frontend"
            
            # 설정 파일 찾기
            if [ -f "$NGINX_CONFIG" ]; then
              CONFIG_FILE="$NGINX_CONFIG"
            elif [ -f "$NGINX_ENABLED" ]; then
              CONFIG_FILE="$NGINX_ENABLED"
            else
              CONFIG_FILE="/etc/nginx/nginx.conf"
            fi
            
            if [ -f "$CONFIG_FILE" ]; then
              echo "Nginx 설정 파일: $CONFIG_FILE"
              echo "=== 현재 프론트엔드 경로 확인 ==="
              CURRENT_ROOT=$(sudo grep -E "^\s*root\s+" "$CONFIG_FILE" | grep -v "#" | head -1 | awk '{print $2}' | tr -d ';' || echo "")
              if [ -n "$CURRENT_ROOT" ]; then
                echo "현재 root 경로: $CURRENT_ROOT"
                echo "새 배포 경로: $FRONTEND_PATH"
                
                # 경로가 다르면 업데이트
                if [ "$CURRENT_ROOT" != "$FRONTEND_PATH" ]; then
                  echo "⚠ 경로가 다릅니다. Nginx 설정 업데이트 중..."
                  # 백업 생성
                  sudo cp "$CONFIG_FILE" "$CONFIG_FILE.backup.$(date +%Y%m%d_%H%M%S)" || true
                  
                  # root 경로 업데이트
                  sudo sed -i "s|root $CURRENT_ROOT|root $FRONTEND_PATH|g" "$CONFIG_FILE" || \
                  sudo sed -i "s|root.*mygame|root $FRONTEND_PATH|g" "$CONFIG_FILE" || \
                  echo "⚠ 자동 업데이트 실패. 수동으로 업데이트 필요: $CONFIG_FILE"
                  
                  echo "업데이트 후 설정 확인:"
                  sudo grep -E "^\s*root\s+" "$CONFIG_FILE" | grep -v "#" || true
                else
                  echo "✓ 경로가 일치합니다"
                fi
              else
                echo "⚠ root 경로를 찾을 수 없습니다"
              fi
            else
              echo "⚠ Nginx 설정 파일을 찾을 수 없습니다"
            fi
            
            # 실제 프론트엔드 파일 위치 확인
            echo "=== 실제 프론트엔드 파일 위치 확인 ==="
            for path in "/var/www/html" "/var/www/mygame" "/var/www/frontend" "/home/ubuntu/frontend" "/usr/share/nginx/html" "$FRONTEND_PATH"; do
              if [ -d "$path" ]; then
                echo "✓ 발견: $path"
                echo "파일 개수: $(find "$path" -type f 2>/dev/null | wc -l)"
                ls -la "$path" | head -5 || true
              fi
            done
            
            # Nginx 설정 테스트
            sudo nginx -t || echo "⚠ Nginx 설정 테스트 실패"
            
            # Nginx 캐시 클리어
            echo "=== Nginx 캐시 클리어 ==="
            sudo rm -rf /var/cache/nginx/* || true
            sudo rm -rf /var/lib/nginx/cache/* || true
            
            # Nginx 재시작
            echo "=== Nginx 재시작 ==="
            sudo systemctl reload nginx || sudo service nginx reload || sudo systemctl restart nginx || sudo service nginx restart || true
            
            # Nginx 상태 확인
            echo "=== Nginx 상태 확인 ==="
            sudo systemctl status nginx --no-pager -l || sudo service nginx status || true
            
            echo "=== 배포 완료 ==="
            echo "프론트엔드 경로: $DEPLOY_PATH/frontend"
            echo "백엔드 경로: $DEPLOY_PATH/backend"
